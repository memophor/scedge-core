<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scedge Control Plane</title>
    <style>
        :root {
            --bg-0: #050912;
            --field-bg: rgba(31, 41, 68, 0.8);
            --field-border: rgba(255, 255, 255, 0.08);
            --field-focus-border: rgba(91, 138, 250, 0.6);
            --field-focus-shadow: rgba(91, 138, 250, 0.18);
            --bg-1: rgba(14, 20, 37, 0.92);
            --bg-2: rgba(21, 29, 52, 0.8);
            --bg-3: rgba(36, 46, 78, 0.75);
            --accent: #5b8afa;
            --accent-soft: rgba(91, 138, 250, 0.18);
            --accent-strong: #7c4dff;
            --success: #34d399;
            --danger: #f87171;
            --warning: #fbbf24;
            --text-strong: #f8fafc;
            --text-soft: #cbd5f5;
            --text-muted: #9aa6d9;
            --border: rgba(114, 138, 212, 0.18);
            --glass-shadow: 0 25px 60px -30px rgba(15, 23, 42, 0.7);
            --radius-lg: 20px;
            --radius-md: 14px;
            --radius-sm: 10px;
            --transition: all 0.25s ease;
        }

        [data-theme="light"] {
            --bg-0: #f4f6ff;
            --field-bg: rgba(255, 255, 255, 0.92);
            --field-border: rgba(148, 163, 184, 0.35);
            --field-focus-border: rgba(37, 99, 235, 0.4);
            --field-focus-shadow: rgba(37, 99, 235, 0.18);
            --bg-1: rgba(255, 255, 255, 0.92);
            --bg-2: rgba(255, 255, 255, 0.86);
            --bg-3: rgba(255, 255, 255, 0.78);
            --accent: #2563eb;
            --accent-soft: rgba(37, 99, 235, 0.15);
            --accent-strong: #6366f1;
            --success: #0ea5e9;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-strong: #101426;
            --text-soft: #1f2a44;
            --text-muted: #64748b;
            --border: rgba(148, 163, 184, 0.2);
            --glass-shadow: 0 25px 60px -30px rgba(15, 23, 42, 0.18);
        }

        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            font-family: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-strong);
            background: radial-gradient(circle at 20% 20%, rgba(91, 138, 250, 0.28) 0%, transparent 50%),
                        radial-gradient(circle at 80% 10%, rgba(124, 77, 255, 0.24) 0%, transparent 45%),
                        var(--bg-0);
            background-attachment: fixed;
        }

        a { color: inherit; text-decoration: none; }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 26px 48px;
        }

        .brand {
            display: flex;
            gap: 18px;
            align-items: center;
        }

        .brand-logo {
            width: 56px;
            height: 56px;
            border-radius: 18px;
            background: linear-gradient(135deg, rgba(91, 138, 250, 0.9), rgba(124, 77, 255, 0.9));
            display: grid;
            place-items: center;
            font-size: 26px;
            font-weight: 700;
            color: #fff;
            box-shadow: 0 18px 45px rgba(91, 138, 250, 0.4);
        }

        .brand-text h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .brand-text span {
            display: block;
            margin-top: 6px;
            font-size: 13px;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .nav-pill {
            display: inline-flex;
            padding: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .nav-pill button {
            padding: 10px 18px;
            border-radius: 999px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-weight: 600;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: var(--transition);
        }

        .nav-pill button.active,
        .nav-pill button:hover {
            background: var(--accent-soft);
            color: var(--text-strong);
        }

        .nav-actions {
            display: flex;
            gap: 14px;
        }

        .nav-actions button {
            border-radius: 999px;
            padding: 11px 20px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.04);
            color: var(--text-soft);
            font-size: 13px;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: var(--transition);
        }

        .nav-actions button:hover {
            background: var(--accent-soft);
            color: var(--text-strong);
        }

        .layout {
            max-width: 1680px;
            margin: 0 auto;
            padding: 12px 36px 80px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 22px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-1);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .stat-card::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(91, 138, 250, 0.25), transparent);
            opacity: 0;
            transition: var(--transition);
        }

        .stat-card:hover::after { opacity: 1; }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .stat-label {
            font-size: 12px;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            display: grid;
            place-items: center;
            font-size: 18px;
            background: rgba(91, 138, 250, 0.12);
            color: var(--accent);
        }

        .stat-value { font-size: 36px; font-weight: 700; }
        .stat-subtext { margin-top: 8px; color: var(--text-muted); font-size: 13px; }

        .content-grid {
            display: grid;
            grid-template-columns: 2.2fr 1fr;
            gap: 28px;
        }

        @media (max-width: 1280px) {
            .content-grid { grid-template-columns: 1fr; }
        }

        .panel {
            background: var(--bg-1);
            border-radius: var(--radius-lg);
            padding: 28px;
            border: 1px solid var(--border);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .panel-header h2 {
            font-size: 20px;
            letter-spacing: 0.05em;
        }

        .panel-subtext {
            margin-top: 6px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .tabs {
            display: inline-flex;
            padding: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .tab {
            border: none;
            border-radius: 999px;
            padding: 10px 20px;
            background: transparent;
            color: var(--text-muted);
            font-weight: 600;
            letter-spacing: 0.04em;
            cursor: pointer;
            transition: var(--transition);
        }

        .tab.active,
        .tab:hover {
            background: var(--accent-soft);
            color: var(--text-strong);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-group { margin-bottom: 18px; }

        .form-label {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            background: var(--field-bg);
            border-radius: var(--radius-sm);
            border: 1px solid var(--field-border);
            padding: 12px 16px;
            color: var(--text-strong);
            font-size: 14px;
            font-family: inherit;
            transition: var(--transition);
            box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.18);
        }

        .form-textarea { min-height: 140px; font-family: 'JetBrains Mono', monospace; resize: vertical; }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--field-focus-border);
            box-shadow: 0 0 0 3px var(--field-focus-shadow);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.05em;
            padding: 12px 22px;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            color: #fff;
            box-shadow: 0 18px 35px -22px rgba(91, 138, 250, 0.8);
        }

        .btn-primary:hover { transform: translateY(-2px); }

        .btn-secondary {
            background: var(--bg-2);
            color: var(--text-soft);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .btn-secondary:hover { background: rgba(255, 255, 255, 0.08); }

        .btn-block { width: 100%; }
        .btn-sm { padding: 10px 16px; font-size: 12px; }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin: 12px 0 8px;
        }

        .response-area {
            display: none;
            margin-top: 18px;
            padding: 18px;
            border-radius: var(--radius-sm);
            background: var(--bg-2);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .response-area pre {
            margin-top: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: var(--text-soft);
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 320px;
            overflow-y: auto;
        }

        .health-pill {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            border-radius: 999px;
            background: rgba(52, 211, 153, 0.14);
            color: var(--success);
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        .health-pill.unhealthy { background: rgba(248, 113, 113, 0.14); color: var(--danger); }

        .metric-list {
            margin-top: 18px;
            display: grid;
            gap: 12px;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            background: var(--bg-2);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .metric-item span:first-child { color: var(--text-muted); font-size: 13px; }

        .history-list {
            max-height: 360px;
            overflow-y: auto;
            display: grid;
            gap: 12px;
        }

        .history-entry {
            padding: 14px;
            border-radius: var(--radius-sm);
            background: var(--bg-2);
            border: 1px solid rgba(255, 255, 255, 0.07);
        }

        .history-entry time {
            display: block;
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .history-entry strong { color: var(--accent); margin-right: 8px; }

        /* Toasts */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 9999;
        }

        .toast {
            min-width: 280px;
            padding: 16px 20px;
            border-radius: 14px;
            background: var(--bg-1);
            border: 1px solid rgba(255, 255, 255, 0.18);
            color: var(--text-soft);
            box-shadow: 0 18px 35px -20px rgba(15, 23, 42, 0.55);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            font-size: 15px;
            animation: slide-in 0.4s ease, fade-out 0.4s ease 4.6s forwards;
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.info { border-left: 4px solid var(--accent); }

        .toast button {
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
        }

        @keyframes slide-in {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fade-out {
            to { opacity: 0; transform: translateX(120%); }
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 999px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>

    <header class="top-bar">
        <div class="brand">
            <div class="brand-logo">SC</div>
            <div class="brand-text">
                <h1>Scedge Control Plane</h1>
                <span>Smart Cache ‚Ä¢ Hydration ‚Ä¢ Observability</span>
            </div>
        </div>
                <div class="nav-pill">
            <button class="active" onclick="switchSection(event, "cache")">Cache</button>
            <button onclick="switchSection(event, "hydrate")">Hydrate</button>
            <button onclick="switchSection(event, "events")">Events</button>
            <button onclick="switchSection(event, "metrics")">Metrics</button>
        </div>
        <div class="nav-actions">
            <button onclick="refreshAll()">Refresh</button>
            <button onclick="toggleTheme()">Toggle Theme</button>
        </div>
    </header>

    <main class="layout" id="section-cache">
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Cache Hits</span>
                    <div class="stat-icon">‚ö°</div>
                </div>
                <div class="stat-value" id="cache-hits">0</div>
                <p class="stat-subtext">Responses served directly from Redis.</p>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Cache Misses</span>
                    <div class="stat-icon" style="color: var(--danger); background: rgba(248, 113, 113, 0.12);">‚õî</div>
                </div>
                <div class="stat-value" id="cache-misses">0</div>
                <p class="stat-subtext">Hydrations routed to Synagraph.</p>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Hydrations</span>
                    <div class="stat-icon" style="color: var(--accent-strong); background: rgba(124, 77, 255, 0.12);">üåê</div>
                </div>
                <div class="stat-value" id="upstream-requests">0</div>
                <p class="stat-subtext" id="upstream-latency-text">Average latency ‚Äì No samples</p>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Hit Ratio</span>
                    <div class="stat-icon" style="color: var(--warning); background: rgba(251, 191, 36, 0.12);">üìà</div>
                </div>
                <div class="stat-value" id="hit-rate">0%</div>
                <p class="stat-subtext">Cache performance over time.</p>
            </div>
        </section>

        <section class="content-grid">
            <div>
                <div class="panel">
                    <div class="panel-header">
                        <div>
                            <h2>Hydration Workbench</h2>
                            <p class="panel-subtext">Probe cache behaviour, force hydrations, and inspect responses.</p>
                        </div>
                        <div class="tabs">
                            <button class="tab active" onclick="switchTab(event, 'lookup-tab')">Lookup</button>
                            <button class="tab" onclick="switchTab(event, 'store-tab')">Store</button>
                            <button class="tab" onclick="switchTab(event, 'purge-tab')">Purge</button>
                            <button class="tab" onclick="switchTab(event, 'bulk-tab')">Bulk</button>
                        </div>
                    </div>

                    <div id="lookup-tab" class="tab-content active">
                        <div class="form-group">
                            <label class="form-label" for="lookup-key">Cache Key</label>
                            <input id="lookup-key" class="form-input" value="demo:greeting:en-US">
                        </div>
                        <button class="btn btn-primary btn-block" onclick="lookupArtifact()">Run Lookup</button>
                        <div class="response-area" id="lookup-response"></div>
                    </div>

                    <div id="store-tab" class="tab-content">
                        <div class="form-group">
                            <label class="form-label" for="store-key">Cache Key</label>
                            <input id="store-key" class="form-input" value="demo:greeting:en-US">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="store-artifact">Artifact JSON</label>
                            <textarea id="store-artifact" class="form-textarea">{
  "answer": "Hello, world!",
  "policy": {"tenant": "demo", "phi": false, "pii": false},
  "provenance": [{"source": "manual-test"}],
  "hash": "v1"
}</textarea>
                        </div>
                        <div class="quick-actions">
                            <button class="btn btn-secondary" onclick="loadExample('greeting')">Greeting</button>
                            <button class="btn btn-secondary" onclick="loadExample('complex')">Analytics</button>
                            <button class="btn btn-secondary" onclick="loadExample('phi')">PHI</button>
                            <button class="btn btn-secondary" onclick="loadExample('json')">JSON API</button>
                            <button class="btn btn-secondary" onclick="loadExample('multilang')">i18n</button>
                        </div>
                        <button class="btn btn-primary btn-block" onclick="storeArtifact()">Store Artifact</button>
                        <div class="response-area" id="store-response"></div>
                    </div>

                    <div id="purge-tab" class="tab-content">
                        <div class="form-group">
                            <label class="form-label" for="purge-mode">Purge Mode</label>
                            <select id="purge-mode" class="form-select" onchange="updatePurgeMode()">
                                <option value="keys">Keys</option>
                                <option value="tenant">Tenant</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" id="purge-label" for="purge-keys">Keys (JSON array)</label>
                            <textarea id="purge-keys" class="form-textarea">["demo:greeting:en-US"]</textarea>
                        </div>
                        <button class="btn btn-primary btn-block" onclick="purgeArtifacts()">Purge Cache</button>
                        <div class="response-area" id="purge-response"></div>
                    </div>

                    <div id="bulk-tab" class="tab-content">
                        <div class="form-group">
                            <label class="form-label" for="bulk-operation">Operation</label>
                            <select id="bulk-operation" class="form-select">
                                <option value="store">Bulk Store</option>
                                <option value="lookup">Bulk Lookup</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="bulk-data">Items JSON</label>
                            <textarea id="bulk-data" class="form-textarea" rows="6">[
  {"key": "test:item1", "artifact": {"answer": "Item 1", "policy": {"tenant": "demo", "phi": false, "pii": false}, "provenance": [], "hash": "v1"}},
  {"key": "test:item2", "artifact": {"answer": "Item 2", "policy": {"tenant": "demo", "phi": false, "pii": false}, "provenance": [], "hash": "v1"}}
]</textarea>
                        </div>
                        <button class="btn btn-primary btn-block" onclick="performBulkOperation()">Execute Bulk</button>
                        <div class="response-area" id="bulk-response"></div>
                    </div>
                </div>

                <div class="panel" style="margin-top: 28px;">
                    <div class="panel-header">
                        <div>
                            <h2>Quick Actions</h2>
                            <p class="panel-subtext">Run maintenance tasks and instrumentation hooks.</p>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-secondary btn-sm" onclick="refreshMetrics()">Refresh Metrics</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearHistory()">Clear History</button>
                        </div>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-secondary" onclick="lookupArtifact()">Hydrate Now</button>
                        <button class="btn btn-secondary" onclick="purgeArtifacts()">Flush Capsule</button>
                        <button class="btn btn-secondary" onclick="exportHistory()">Export History</button>
                        <button class="btn btn-secondary" onclick="refreshAll()">Full Refresh</button>
                    </div>
                </div>
            </div>

            <aside>
                <div class="panel">
                    <div class="panel-header">
                        <div>
                            <h2>System Health</h2>
                            <p class="panel-subtext">Live snapshot from `/healthz`.</p>
                        </div>
                    </div>
                    <div id="health-status">Checking‚Ä¶</div>
                    <div class="metric-list">
                        <div class="metric-item">
                            <span>Hydration Failures</span>
                            <span id="upstream-failures">0</span>
                        </div>
                        <div class="metric-item">
                            <span>Cache Stores</span>
                            <span id="cache-stores">0</span>
                        </div>
                    </div>
                </div>

                <div class="panel" style="margin-top: 28px;">
                    <div class="panel-header">
                        <div>
                            <h2>Recent Activity</h2>
                            <p class="panel-subtext">Latest cache operations and hydrations.</p>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="exportHistory()">Download</button>
                    </div>
                    <div id="history-panel" class="history-list">
                        <p style="color: var(--text-muted); text-align: center;">No requests yet</p>
                    </div>
                </div>
            </aside>
        </section>
    </main>

    <script>
        const API_BASE = window.location.origin;
        let requestHistory = JSON.parse(localStorage.getItem('scedge-history') || '[]');

        const toastContainer = document.getElementById('toast-container');

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${message}</span>
                <button aria-label="Dismiss" onclick="dismissToast(this)">√ó</button>
            `;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        function dismissToast(button) {
            const toast = button.closest('.toast');
            if (toast) toast.remove();
        }

        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('scedge-theme', next);
            showToast(`Switched to ${next} theme`, 'info');
        }

        (function initialiseTheme() {
            const saved = localStorage.getItem('scedge-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
        })();

        function switchTab(evt, tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            evt.currentTarget.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/healthz`);
                const data = await response.json();
                document.getElementById('health-status').innerHTML = `
                    <div class="health-pill">
                        <span class="health-dot healthy"></span>
                        <span>${data.status.toUpperCase()}</span>
                    </div>
                    <p class="panel-subtext" style="margin-top:12px;">${data.service} ¬∑ v${data.version}</p>
                `;
            } catch (error) {
                document.getElementById('health-status').innerHTML = `
                    <div class="health-pill unhealthy">
                        <span class="health-dot unhealthy"></span>
                        <span>UNHEALTHY</span>
                    </div>
                    <p class="panel-subtext" style="margin-top:12px;color:var(--danger);">${error.message}</p>
                `;
                showToast('Health check failed', 'error');
            }
        }

        async function refreshMetrics() {
            try {
                const response = await fetch(`${API_BASE}/metrics`);
                const text = await response.text();
                const hits = parseInt(extractMetric(text, 'scedge_cache_hits_total'));
                const misses = parseInt(extractMetric(text, 'scedge_cache_misses_total'));
                const stores = parseInt(extractMetric(text, 'scedge_cache_stores_total'));
                const hydrations = parseInt(extractMetric(text, 'scedge_upstream_requests_total'));
                const failures = parseInt(extractMetric(text, 'scedge_upstream_failures_total'));
                const latencySum = parseFloat(extractMetric(text, 'scedge_upstream_latency_seconds_sum'));
                const latencyCount = parseFloat(extractMetric(text, 'scedge_upstream_latency_seconds_count'));

                const hitRate = hits + misses > 0 ? `${((hits / (hits + misses)) * 100).toFixed(1)}%` : '0%';
                const latencyText = latencyCount > 0 ? `${Math.round((latencySum / latencyCount) * 1000)} ms` : 'No samples';

                document.getElementById('cache-hits').textContent = hits;
                document.getElementById('cache-misses').textContent = misses;
                document.getElementById('cache-stores').textContent = stores;
                document.getElementById('upstream-requests').textContent = hydrations;
                document.getElementById('upstream-failures').textContent = failures;
                document.getElementById('upstream-latency-text').textContent = `Average latency ‚Äì ${latencyText}`;
                document.getElementById('hit-rate').textContent = hitRate;
            } catch (error) {
                console.error('Failed to fetch metrics', error);
                showToast('Failed to refresh metrics', 'error');
            }
        }

        function extractMetric(text, metricName) {
            const regex = new RegExp(`${metricName}(?:._bucket)?\\s+([0-9.e+-]+)`);
            const match = text.match(regex);
            return match ? match[1] : '0';
        }

        async function storeArtifact() {
            const key = document.getElementById('store-key').value;
            const artifactText = document.getElementById('store-artifact').value;
            try {
                const artifact = JSON.parse(artifactText);
                const start = performance.now();
                const response = await fetch(`${API_BASE}/store`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key, artifact })
                });
                const duration = Math.round(performance.now() - start);
                const data = await response.json();
                showResponse('store-response', data, response.ok, duration);
                addToHistory('STORE', key, data);
                if (response.ok) {
                    refreshMetrics();
                    showToast('Artifact stored', 'success');
                } else {
                    showToast(data.error || 'Store failed', 'error');
                }
            } catch (error) {
                showResponse('store-response', { error: error.message }, false);
                showToast(error.message, 'error');
            }
        }

        async function lookupArtifact() {
            const key = document.getElementById('lookup-key').value;
            try {
                const start = performance.now();
                const response = await fetch(`${API_BASE}/lookup?key=${encodeURIComponent(key)}`);
                const duration = Math.round(performance.now() - start);
                const data = await response.json();
                showResponse('lookup-response', data, response.ok, duration);
                addToHistory('LOOKUP', key, data);
                if (response.ok) {
                    refreshMetrics();
                    showToast('Lookup complete', 'success');
                } else {
                    showToast(data.error || 'Lookup failed', 'error');
                }
            } catch (error) {
                showResponse('lookup-response', { error: error.message }, false);
                showToast(error.message, 'error');
            }
        }

        function updatePurgeMode() {
            const mode = document.getElementById('purge-mode').value;
            const label = document.getElementById('purge-label');
            const textarea = document.getElementById('purge-keys');
            if (mode === 'keys') {
                label.textContent = 'Keys (JSON array)';
                textarea.value = '["demo:greeting:en-US"]';
            } else {
                label.textContent = 'Tenant ID';
                textarea.value = 'demo';
            }
        }

        async function purgeArtifacts() {
            const mode = document.getElementById('purge-mode').value;
            const inputText = document.getElementById('purge-keys').value;
            try {
                let body;
                if (mode === 'keys') {
                    body = { keys: JSON.parse(inputText) };
                } else {
                    body = { tenant: inputText };
                }
                const start = performance.now();
                const response = await fetch(`${API_BASE}/purge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const duration = Math.round(performance.now() - start);
                const data = await response.json();
                showResponse('purge-response', data, response.ok, duration);
                addToHistory('PURGE', mode === 'keys' ? JSON.stringify(body.keys) : body.tenant, data);
                if (response.ok) {
                    refreshMetrics();
                    showToast('Purge executed', 'info');
                } else {
                    showToast(data.error || 'Purge failed', 'error');
                }
            } catch (error) {
                showResponse('purge-response', { error: error.message }, false);
                showToast(error.message, 'error');
            }
        }

        async function performBulkOperation() {
            const mode = document.getElementById('bulk-operation').value;
            const dataText = document.getElementById('bulk-data').value;
            try {
                const items = JSON.parse(dataText);
                const responses = [];
                const start = performance.now();
                if (mode === 'store') {
                    for (const item of items) {
                        const res = await fetch(`${API_BASE}/store`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(item)
                        });
                        responses.push(await res.json());
                    }
                } else {
                    for (const item of items) {
                        const res = await fetch(`${API_BASE}/lookup?key=${encodeURIComponent(item.key)}`);
                        responses.push(await res.json());
                    }
                }
                const duration = Math.round(performance.now() - start);
                showResponse('bulk-response', responses, true, duration);
                addToHistory(mode === 'store' ? 'BULK_STORE' : 'BULK_LOOKUP', `${items.length} items`, responses);
                refreshMetrics();
                showToast('Bulk operation complete', 'success');
            } catch (error) {
                showResponse('bulk-response', { error: error.message }, false);
                showToast(error.message, 'error');
            }
        }

        function showResponse(elementId, payload, ok, duration = null) {
            const container = document.getElementById(elementId);
            if (!container) return;
            container.style.display = 'block';
            const status = ok ? 'Success' : 'Error';
            const timing = duration !== null ? `<span>${duration} ms</span>` : '';
            container.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-weight:600;letter-spacing:0.05em;">${status}</span>
                    <span style="color:var(--text-muted);font-size:12px;">${timing}</span>
                </div>
                <pre>${JSON.stringify(payload, null, 2)}</pre>
                <div style="margin-top:12px;display:flex;gap:10px;">
                    <button class="btn btn-secondary btn-sm" onclick="copyResponse(this)">Copy JSON</button>
                </div>
            `;
        }

        function copyResponse(button) {
            const pre = button.closest('.response-area').querySelector('pre');
            navigator.clipboard.writeText(pre.textContent);
            showToast('Copied to clipboard', 'info');
        }

        function addToHistory(method, key, data) {
            const entry = { timestamp: new Date().toISOString(), method, key, data };
            requestHistory.unshift(entry);
            if (requestHistory.length > 50) requestHistory.pop();
            localStorage.setItem('scedge-history', JSON.stringify(requestHistory));
            updateHistoryPanel();
        }

        function updateHistoryPanel() {
            const panel = document.getElementById('history-panel');
            if (requestHistory.length === 0) {
                panel.innerHTML = '<p style="color: var(--text-muted); text-align:center;">No requests yet</p>';
                return;
            }
            panel.innerHTML = requestHistory.slice(0, 12).map(entry => `
                <div class="history-entry">
                    <time>${new Date(entry.timestamp).toLocaleString()}</time>
                    <div><strong>${entry.method}</strong>${entry.key}</div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (!confirm('Clear all request history?')) return;
            requestHistory = [];
            localStorage.setItem('scedge-history', '[]');
            updateHistoryPanel();
            showToast('History cleared', 'info');
        }

        function exportHistory() {
            const blob = new Blob([JSON.stringify(requestHistory, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `scedge-history-${Date.now()}.json`;
            link.click();
            showToast('History exported', 'success');
        }

        function loadExample(type) {
            const examples = {
                greeting: {
                    key: 'demo:greeting:en-US',
                    artifact: {
                        answer: 'Hello, world!',
                        policy: { tenant: 'demo', phi: false, pii: false },
                        provenance: [{ source: 'manual-test' }],
                        hash: 'v1'
                    }
                },
                complex: {
                    key: 'acme:analytics:report',
                    artifact: {
                        answer: {
                            summary: 'Q4 Revenue increased by 23%',
                            highlights: ['North America +32%', 'EMEA +18%']
                        },
                        policy: { tenant: 'acme', phi: false, pii: false },
                        provenance: [{ source: 'analytics-engine' }],
                        hash: 'rev-q4-v1'
                    }
                },
                phi: {
                    key: 'healthcare:patient:summary',
                    artifact: {
                        answer: 'Patient exhibits stable vitals.',
                        policy: {
                            tenant: 'healthcare',
                            phi: true,
                            pii: true,
                            compliance_tags: ['HIPAA']
                        },
                        provenance: [{ source: 'ehr-system' }],
                        hash: 'phi-2025-01'
                    }
                },
                json: {
                    key: 'api:response:users',
                    artifact: {
                        answer: { users: [{ id: 1, name: 'Alice' }], next_cursor: null },
                        policy: { tenant: 'api', phi: false, pii: false },
                        provenance: [{ source: 'user-service' }],
                        hash: 'users-v1'
                    }
                },
                multilang: {
                    key: 'i18n:welcome:es-ES',
                    artifact: {
                        answer: '¬°Bienvenido a Scedge Core!',
                        policy: { tenant: 'i18n', phi: false, pii: false },
                        provenance: [{ source: 'translation-service' }],
                        hash: 'es-es-v1'
                    }
                }
            };

            const example = examples[type];
            if (!example) return;
            document.getElementById('store-key').value = example.key;
            document.getElementById('store-artifact').value = JSON.stringify(example.artifact, null, 2);
            showToast(`Loaded ${type} template`, 'info');
        }

        async function refreshAll() {
            document.querySelectorAll('.response-area').forEach(box => {
                box.style.display = 'none';
                box.innerHTML = '';
            });
            await Promise.all([refreshMetrics(), checkHealth()]);
            showToast('Dashboard refreshed', 'info');
        }

        checkHealth();
        refreshMetrics();
        updateHistoryPanel();
        setInterval(refreshMetrics, 5000);
        setInterval(checkHealth, 30000);
    </script>
</body>
</html>
